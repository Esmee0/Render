<!DOCTYPE html>
<html>
<head>
  <title>Relaybot dashboard</title>
  <style>
body {
  background: #181a1d;
  color: #eee;
  font-family: 'Segoe UI', 'Roboto', sans-serif;
  min-height: 100vh;
  margin: 0;
  display: flex; flex-direction: column; align-items: center;
}
h1 {
  text-align: center;
  margin: 2.5rem 0 2rem 0;
  color: #3ed6fa;
  font-size: 2.5rem;
  letter-spacing: 0.02em;
  font-weight: 700;
  text-shadow: 0 6px 30px #000c;
}
#robot-cars-container {
  display: flex;
  justify-content: center;
  gap: 2rem;
  flex-wrap: wrap;
  margin-bottom: 3rem;
}
.robot-car-box {
  background: #23252d;
  border-radius: 1.7rem;
  box-shadow: 0 6px 30px #0196df26;
  padding: 2rem 3rem 2.2rem 3rem;
  display: flex; flex-direction: column; align-items: center;
  margin: 1.5rem 0 1rem 0;
  min-width: 260px; max-width: 340px;
  transition: transform 0.12s;
}
.robot-car-box:hover { transform: scale(1.03);}
.tesla-car-svg {
  width: 180px;
  height: 86px;
  margin-bottom: 1.16rem;
  display: block;
}
.status-box {
  text-align: center;
  margin: 0.8rem 0 0 0;
  font-size: 1.2rem;
  font-weight: 500;
  letter-spacing: 0.01em;
  min-height: 1.8em;
}
.status-box.obstacle { color: #ff4848; }
.status-box.moving { color: #39ffb2; }
.status-box.waiting { color: #ffd700; }
.status-box.offline { color: #8f96a7; }
#last-seen, #ping-count {
  font-size: 0.95em;
  margin: 0.35em 0;
  color: #95d5e7;
  text-align: center;
}
.robot-title {
  color: #32e6ff;
  margin-bottom: 0.3em;
  font-weight: 600;
  font-size: 1.26em;
  text-align: center;
}
@media (max-width:900px) {
  #robot-cars-container { flex-direction: column; align-items: center;}
  .robot-car-box { min-width: 70vw; max-width: 99vw;}
}
  </style>
</head>
<body>
<h1>Relayrace dashboard</h1>
<div id="robot-cars-container"></div>
<script>
// colors and status based on last_data text
function getStatusProps(statusText, isOffline) {
  if (isOffline) {
      return {
          fill:'#888', glass:'#cccccc', lights:'#adacac', status:'offline'
      };
  }
  let L = (statusText||"").toLowerCase();
  if (L.includes("obstacle")) return {
      fill:'#ff4848', glass:'#ffd7c0', lights:'#ffe3d6', status:'obstacle'
  };
  if (L.includes("wait")) return {
      fill:'#ffd700', glass:'#fffbe4', lights:'#fffbe0', status:'waiting'
  };
  if (L.length>1) return {
      fill:'#23bffe', glass:'#fff', lights:'#fffbe0', status:'moving'
  };
  return { fill:'#888', glass:'#cccccc', lights:'#adacac', status:'offline'}
}
// HTML for 1 robot
function formatCarBox(r, isOffline=false) {
  let stprops = getStatusProps(r.last_data, isOffline);
  return `
  <div class="robot-car-box">
    <div class="robot-title">${r.robot_name || r.robot_id} <span style="font-size:0.8em; color:#bababa;">(${r.robot_id})</span></div>
    <svg class="tesla-car-svg" viewBox="0 0 180 86" fill="none">
      <ellipse cx="90" cy="80" rx="65" ry="6" fill="#232c33" opacity="0.21"/>
      <rect x="27" y="44" width="126" height="23" rx="11" fill="#15171a"/>
      <rect x="30" y="42" width="120" height="19" rx="9" fill="${stprops.fill}"/>
      <rect x="75" y="37" width="30" height="13" rx="6.5" fill="${stprops.glass}" fill-opacity="0.72"/>
      <circle cx="47" cy="72" r="12" fill="#222" stroke="#111" stroke-width="3"/>
      <circle cx="133" cy="72" r="12" fill="#222" stroke="#111" stroke-width="3"/>
      <ellipse cx="31" cy="53" rx="4" ry="2" fill="${stprops.lights}" />
      <ellipse cx="148" cy="53" rx="4" ry="2" fill="${stprops.lights}" />
    </svg>
    <div class="status-box ${stprops.status}">
      ${isOffline ? "Offline" : (r.last_data ? r.last_data : "No status")}
    </div>
    <div id="last-seen">last ping: ${r.last_seen? new Date(r.last_seen).toLocaleString() : '-'}</div>
    <div id="ping-count">Ping count: ${r.ping_count}</div>
  </div>
`;}
async function fetchRobots() {
    const res = await fetch("/api/robots");
    let robots = await res.json();
    let now = Date.now();
    // Sort robots by id (for fixed position: R1, R2, R3)
    robots = robots.sort((a, b) => (a.robot_id||"").localeCompare(b.robot_id||""));

    // Build a map per id, and collect ids
    let robotMap = {};
    robots.forEach(r => { robotMap[r.robot_id] = r; });
    let ids = robots.map(r => r.robot_id);

    // Fill empty spots up to 3 (e.g., R1, R2, R3 as default)
    let ids_set = new Set(ids);
    while(ids.length < 3) {
        let candidate = "R" + (ids.length + 1);
        while(ids_set.has(candidate)) {
            candidate = "R" + (Math.floor(Math.random()*300)+10);
        }
        ids.push(candidate);
        ids_set.add(candidate);
    }
    // Per id show robot live, or offline/placeholder if not active
    let html = ids.slice(0,3).map(id => {
        let r = robotMap[id] || {robot_id:id, robot_name:id, ping_count:0};
        let lastPing = r.last_seen ? new Date(r.last_seen).getTime() : 0;
        let secondsSincePing = ((now - lastPing)/1000);
        let isOffline = (!r.last_seen) || (secondsSincePing > 10);
        return formatCarBox(r, isOffline);
    }).join('\n');
    document.getElementById('robot-cars-container').innerHTML = html;
}
fetchRobots();
setInterval(fetchRobots, 1500);
</script>
</body>
</html>