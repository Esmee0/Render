<!DOCTYPE html>
<html>
<head>
  <title>Relayrobot Dashboard - Linker Focus</title>
  <style>
body {
  background: #181a1d;
  color: #eee;
  font-family: 'Segoe UI', 'Roboto', sans-serif;
  min-height: 100vh;
  margin: 0;
  display: flex; flex-direction: column; align-items: center;
}
h1 {
  margin: 2.2rem 0 1.1rem 0;
  color: #3ed6fa;
  font-size: 2.3rem;
  letter-spacing: 0.02em;
  font-weight: 700;
  text-shadow: 0 6px 30px #000a;
}
#dashboard-flex {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  justify-content: center;
  gap: 2.5rem;
  width: 100vw;
  max-width: 1200px;
  margin-top: 2.5rem;
}
.robot-card,
.robot-card-big {
  background: #23252d;
  border-radius: 1.6rem;
  box-shadow: 0 6px 30px #007abba1;
  display: flex; flex-direction: column; align-items: center;
  margin: 0;
  transition: box-shadow 0.13s, transform 0.18s, filter 0.11s;
  border: 2.5px solid transparent;
  cursor: pointer;
}
.robot-card {
  min-width: 230px; max-width: 340px; padding: 2rem 2.2rem 2.1rem 2.2rem;
}
.robot-card-big { 
  min-width: 370px; max-width: 440px; padding: 2.7rem 3rem 2.6rem 3rem; 
  z-index:2; box-shadow: 0 14px 60px #0bfdfe41;
}
.robot-card:hover, .robot-card-big:hover { border: 2.5px solid #2af8ff; filter:brightness(1.07);}
.robot-card.selected { border: 2.5px solid #2af8ff; filter: brightness(1.14);}
.tesla-car-svg { width: 160px; height: 76px; margin-bottom: 1.09rem;}
.robot-card-big .tesla-car-svg { width: 220px; height: 106px; margin-bottom: 1.6rem;}
.robot-title { color: #32e6ff; margin-bottom: 0.38em; font-weight: 600; font-size: 1.18em; text-align: center;}
.robot-card-big .robot-title { font-size: 1.46em;}
.status-box {
  text-align: center;
  margin: 0.8rem 0 0 0;
  font-size: 1.09rem;
  font-weight: 500;
  letter-spacing: 0.01em;
  min-height: 1.8em;}
.status-box.obstacle { color: #ff4848; }
.status-box.moving { color: #39ffb2; }
.status-box.waiting { color: #ffd700; }
.status-box.offline { color: #8f96a7; }
#last-seen, #ping-count,
.robot-card-big #last-seen, .robot-card-big #ping-count {
  font-size: 0.93em;
  margin: 0.28em 0;
  color: #95d5e7;
  text-align: center;
}
.robot-card-big #last-seen, .robot-card-big #ping-count {
  font-size: 1.08em;
  color: #b1efff;
}
#focus-controls {
  margin-top: 1.1em;
  display: flex; flex-direction: row; gap: 1.8em; justify-content: center;
}
.control-btn {
  background: linear-gradient(92deg,#2af8ff 20%,#48d6be 90%);
  color: #0e2d3f; font-size: 1.09em; padding: 0.56em 1.5em; border: none;
  border-radius: 0.88em; font-weight: 700; margin: 0 0.33em;
  cursor: pointer; transition: filter 0.09s;
  box-shadow: 0 2px 12px #11eae745;
}
.control-btn.off {
  background: linear-gradient(92deg,#ff4848 30%,#ffd700 95%);
  color: #251f00;
}
.control-btn:active { filter: brightness(0.91);}
#sidebar-right {
  display: flex;
  flex-direction: column;
  gap: 1.7rem;
  align-items: center;
}
@media (max-width: 900px) {
  #dashboard-flex { flex-direction: column; align-items:center; gap: 2rem;}
  #sidebar-right { flex-direction: row; gap: 1.3rem;}
  .robot-card, .robot-card-big { min-width: 80vw; max-width: 99vw;}
}
  </style>
</head>
<body>
<h1>Relayrobot Dashboard</h1>
<div id="dashboard-flex"></div>
<script>
// === Altijd 3 plekken: "R1", "R2", "R3" ===
const robotIdList = ["R1", "R2", "R3"];
let allRobots = [];
let robotMap = {};
let focusRobotId = null;

function getStatusProps(statusText, isOffline) {
  if (isOffline) return { fill:'#888', glass:'#cccccc', lights:'#adacac', status:'offline' };
  let L = (statusText||"").toLowerCase();
  if (L.includes("obstacle")) return { fill:'#ff4848', glass:'#ffd7c0', lights:'#ffe3d6', status:'obstacle' };
  if (L.includes("wait"))     return { fill:'#ffd700', glass:'#fffbe4', lights:'#fffbe0', status:'waiting' };
  if (L.length>1)             return { fill:'#23bffe', glass:'#fff', lights:'#fffbe0', status:'moving' };
  return { fill:'#888', glass:'#cccccc', lights:'#adacac', status:'offline' }
}
function formatRobotCard(r, isOffline, isBig, selected) {
  let st = getStatusProps(r.last_data, isOffline);
  return `
  <div class="${isBig?'robot-card-big':'robot-card'}${selected?' selected':''}"
       data-id="${r.robot_id}" tabindex="0" title="Klik voor meer info">
    <div class="robot-title">${r.robot_name || r.robot_id} <span style="font-size:0.8em; color:#bababa;">(${r.robot_id})</span></div>
    <svg class="tesla-car-svg" viewBox="0 0 180 86">
      <ellipse cx="90" cy="80" rx="65" ry="6" fill="#232c33" opacity="0.21"/>
      <rect x="27" y="44" width="126" height="23" rx="11" fill="#15171a"/>
      <rect x="30" y="42" width="120" height="19" rx="9" fill="${st.fill}"/>
      <rect x="75" y="37" width="30" height="13" rx="6.5" fill="${st.glass}" fill-opacity="0.72"/>
      <circle cx="47" cy="72" r="12" fill="#222" stroke="#111" stroke-width="3"/>
      <circle cx="133" cy="72" r="12" fill="#222" stroke="#111" stroke-width="3"/>
      <ellipse cx="31" cy="53" rx="4" ry="2" fill="${st.lights}" />
      <ellipse cx="148" cy="53" rx="4" ry="2" fill="${st.lights}" />
    </svg>
    <div class="status-box ${st.status}">
      ${isOffline ? "Offline" : (r.last_data ? r.last_data : "Geen status")}
    </div>
    <div id="last-seen">Laatste ping: ${r.last_seen? new Date(r.last_seen).toLocaleString() : '-'}</div>
    <div id="ping-count">Aantal pings: ${r.ping_count||0}</div>
    ${isBig ? `
    <div id="focus-controls">
      <button class="control-btn" onclick="sendRobotCommand('${r.robot_id}', 'START');event.stopPropagation();">&#9654; Aan</button>
      <button class="control-btn off" onclick="sendRobotCommand('${r.robot_id}', 'STOP');event.stopPropagation();">&#9632; Uit</button>
    </div>` : ''}
  </div>`;
}
async function fetchRobots() {
    const res = await fetch("/api/robots");
    let robots = await res.json();
    let now = Date.now();
    robotMap = {};
    robots.forEach(r=>{ robotMap[r.robot_id]=r;});
    allRobots = robotIdList.map(id => {
      let r = robotMap[id] || {robot_id:id, robot_name:id, ping_count:0, last_seen:null, last_data:""};
      return r;
    });
    updateDisplay();
}
function updateDisplay() {
  let now = Date.now();
  let dashboard = document.getElementById("dashboard-flex");
  if(!dashboard) return;
  if(!allRobots.length) {
    dashboard.innerHTML = `<div class="robot-card"><div class="robot-title">Geen robot online</div></div>`;
    return;
  }
  if(focusRobotId){
    let bigIx = allRobots.findIndex(r=>r.robot_id===focusRobotId);
    // alle indices behalve de gefocusde
    let miniIx = [];
    for(let i=0; i<allRobots.length; ++i) if(i !== bigIx) miniIx.push(i);
    dashboard.innerHTML = '';
    // links grote kaart
    let r = allRobots[bigIx];
    let lastPing = r.last_seen ? new Date(r.last_seen).getTime() : 0;
    let isOffline = (!r.last_seen) || ((now - lastPing)/1000 > 10);
    dashboard.innerHTML += formatRobotCard(r, isOffline, true, true);
    // rechts: 2 kleine onder elkaar
    dashboard.innerHTML += `<div id="sidebar-right"></div>`;
    let sidebar = document.getElementById("sidebar-right");
    miniIx.forEach(ix=>{
      let r = allRobots[ix];
      let lastPing = r.last_seen ? new Date(r.last_seen).getTime() : 0;
      let isOffline = (!r.last_seen) || ((now - lastPing)/1000 > 10);
      sidebar.innerHTML += formatRobotCard(r, isOffline, false, false);
    });
    // Add eventlisteners â€” grote: klik = uit focus, kleine: klik = focus die
    const allCards = document.querySelectorAll('.robot-card, .robot-card-big');
    allCards.forEach(el => {
      let id = el.getAttribute("data-id");
      if(id === focusRobotId) {
        el.onclick = ()=> { focusRobotId=null; updateDisplay();}
        el.onkeyup = (e)=>{ if(e.key==='Enter') { focusRobotId=null; updateDisplay();}}
      } else {
        el.onclick = ()=> { focusRobotId=id; updateDisplay();}
        el.onkeyup = (e)=>{ if(e.key==='Enter') { focusRobotId=id; updateDisplay();}}
      }
    });
  } else {
    // Normaal: allemaal naast elkaar (groot)
    dashboard.innerHTML = allRobots.map(r=>{
      let lastPing = r.last_seen ? new Date(r.last_seen).getTime() : 0;
      let isOffline = (!r.last_seen) || ((now - lastPing)/1000 > 10);
      return formatRobotCard(r, isOffline, false, false);
    }).join('');
    // Click events om focus te zetten
    Array.from(document.querySelectorAll(".robot-card")).forEach(el => {
      el.onclick = ()=>{ focusRobotId = el.getAttribute("data-id"); updateDisplay();}
      el.onkeyup = (e)=>{ if(e.key==='Enter') { focusRobotId = el.getAttribute("data-id"); updateDisplay();}}
    });
  }
}
function sendRobotCommand(robotId, cmd) {
  fetch('/api/command', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ robot_id: robotId, command: cmd })
    }).then(r => r.json())
     .then(obj => alert('Commando verstuurd: ' + obj.status));
}
fetchRobots();
setInterval(fetchRobots, 1400);
</script>
</body>
</html>